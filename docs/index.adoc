= Open ID Connect ID Provider
:imagesdir: media/

{zwsp} +

Authenticate your users using Open ID Connect.

This ID Provider application, acting as an OIDC Relying Party, will verify the identity of End-Users based on the authentication performed by your OIDC Authorization Server.
It will redirect unauthenticated users to the Authentication Server and obtain basic information in order to create a user within Enonic XP.
This ID Provider application follows the Authorization Code Flow and uses one of the `client_secret_post`, `client_secret_basic` or `client_secret_jwt` client authentication methods.

This ID Provider supports also Auto Login by JWT Bearer Token, making it suitable for Stateless Authentication.

It is possible to mix the two authentication methods in the same ID Provider.

{zwsp} +
{zwsp} +

== Configuration

{zwsp} +

[[authorization_server]]
=== Authorization Server

The configuration depends on the Authorization Server selected and is not covered by this documentation.
It will typically require the creation and configuration of a Client/Application. The following information is needed:

{zwsp} +

[[redirection_callback_uri]]
==== Redirection/Callback URI

Once authenticated by the Authorization Server, the End-User will be redirected to Enonic XP.
During the configuration of your Client/Application, you will have to register this callback URL.
The callback URL depends on the VHost mapping and the name of the ID Provider.
It has the following format:  `[VHost source]/_/idprovider/[ID Provider name]`. Make sure the ID Provider name exactly <<#id_provider_creation, matches the name of the ID provider>> (aka "userstore") in the User Admin app.

{zwsp} +

**Example for a site:** `https://www.example.com/_/idprovider/myoidcprovider`

**Example for admin:** `https://www.example.com/admin/tool/_/idprovider/myoidcprovider`

{zwsp} +

[[information_required_for_config]]
==== Information required for the ID Provider Config for Authorization Code Flow

You will need to gather the following information from the Authorization Server setup, for the <<#id_provider_creation, ID Provider configuration>>

. The Client ID.
. The Client secret.
. The Issuer Identifier (URL). `issuer`
. The Authorization endpoint URL. `authorization_endpoint`
. The Token endpoint URL. `token_endpoint`

NOTE: Starting from version 3.0, it is possible to specify `oidcWellKnownEndpoint` (Provider's OpenID Connect Discovery URL) configuration that ID Provider uses to obtain the values for the `issuer`, `authorization_endpoint`, `token_endpoint` as well as optional `userinfo_endpoint` and `jwks_uri`  properties.

You might have been given only the Issuer URL instead of the list of endpoint URLs.
In that case the endpoint URLs are likely accessible under: `[Issuer URL]/.well-known/openid-configuration`


Examples of OpenID Connect Discovery URL:

- **Auth0**: https://`YOUR_AUTH0_DOMAIN`/.well-known/openid-configuration

- **Google**: https://accounts.google.com/.well-known/openid-configuration

- **Azure AD**: https://login.microsoftonline.com/`TenantID`/.well-known/openid-configuration

- **ID-porten**: https://idporten.no/.well-known/openid-configuration

{zwsp} +

[[information_required_for_config_auto_login]]
==== Information required for the ID Provider Config for Auto Login

If you want to enable Auto Login, you need to specify the `jwksUri` in the ID Provider configuration or `oidcWellKnownEndpoint` that ID Provider uses to obtain the value for the `jwksUri` automatically.

=== Enonic XP

==== Application Installation

. In the admin tool "Applications", click on "Install".
. Select the tab "Enonic Market", find "OIDC ID Provider", and click on the link "Install".

{zwsp} +

[[id_provider_creation]]
==== ID Provider creation

. In the https://www.youtube.com/watch?v=QZpBdsDlkA0[admin tool "Users"], click on "New" and select "Id Provider".
. Fill in the `displayName` field, which pre-fills the *ID provider name* just below. The ID provider name must match the name set in the <<#redirection_callback_uri, Authorization server>>:
+
.ID provider name:
+
image:idprovider-name.png[title="ID provider name is found/set in the name field below the displayName", width=500px]
+
The ID provider name can be edited before saving, but not changed later.
. For the field "Application", select the "OIDC ID Provider" application.


{zwsp} +

==== Virtual Host Mapping configuration

Edit the configuration file `com.enonic.xp.web.vhost.cfg`, and set the new user store to your virtual host. (See https://developer.enonic.com/docs/xp/stable/deployment/vhosts[Virtual Host Configuration] for more information).

[source,properties]
----
mapping.example.host = example.com
mapping.example.source = /
mapping.example.target = /portal/master/mysite
mapping.example.idProvider.myoidcprovider = default
----

Here as well, the ID provider name must match: see the last line.

{zwsp} +

[[idp_config]]
=== ID Provider

As of v2.0.0, the config form in the users app (`idprovider.xml`) has been removed. The settings to configure the id provider must instead be entered in a .cfg file: com.enonic.app.oidcidprovider.cfg.

This config file should contain config fields for all OpenID providers in the format `idprovider.[idprovidername].[configkey] = [value]`, where `idprovidername` should exactly match ID provider name from the Users app. For example, setting the `forceEmailVerification` rule config field with a value of `true` for an ID provider named `myoidcprovider`, will look like this: `idprovider.myoidcprovider.rules.forceEmailVerification=true`

The ID Provider must be configured, many of the fields are the information gathered from <<#information_required_for_config, authorization server configuration>> (optionally available at the _WellKnown_ endpoint of your Authorization server, `/.well-known/openid-configuration`).


{zwsp} +

==== Overview

The following settings are allowed to be used in `com.enonic.app.oidcidprovider.cfg` (<<#fields_in_config, field descriptions>> follow below):

[source,properties]
----
autoinit=  (true | false, optional)

idprovider.<idprovidername>.displayName=  (string, optional)
idprovider.<idprovidername>.description=  (string, optional)

idprovider.<idprovidername>.oidcWellKnownEndpoint= (string, optional) # if defined, then values for the 'issuer', 'authorizationUrl','tokenUrl','userinfoUrl','jwksUri' properties will be fetched from the well-known endpoint.
idprovider.<idprovidername>.issuer=  (string, optional)
idprovider.<idprovidername>.authorizationUrl=  (string, optional)
idprovider.<idprovidername>.tokenUrl=  (string, optional)
idprovider.<idprovidername>.userinfoUrl=  (string, optional)
idprovider.<idprovidername>.jwksUri=  (string, optional)

idprovider.<idprovidername>.useUserinfo= (true|false, optional, defaults to "true")
idprovider.<idprovidername>.claimUsername= (string, optional, defaults to "sub")
idprovider.<idprovidername>.method=  ((basic|post|jwt), optional, default to "post")
idprovider.<idprovidername>.scopes=  (space separated strings, optional, default to "profile email")
idprovider.<idprovidername>.usePkce= (true|false, optional, defaults to "true")

# Optional 'additionalEndpoints' namespace
# Is an array, that uses index (integer, starts from 0) to set items with 'name' and 'url' fields
idprovider.<idprovidername>.additionalEndpoints.0.name=  (string, required)
idprovider.<idprovidername>.additionalEndpoints.0.url=  (string, required)

# Optional 'endSession' namespace
idprovider.<idprovidername>.endSession.url=  (string, required)
idprovider.<idprovidername>.endSession.idTokenHintKey=  (string, optional)
idprovider.<idprovidername>.endSession.postLogoutRedirectUriKey=  (string, optional)

# Optional 'additionalParameters' namespace
# Is an array, that uses index (integer, starts from 0) to set items with 'key' and 'value' fields
idprovider.<idprovidername>.endSession.additionalParameters.0.key=  (string, required)
idprovider.<idprovidername>.endSession.additionalParameters.0.value=  (string, required)

idprovider.<idprovidername>.clientId=  (string, optional)
idprovider.<idprovidername>.clientSecret=  (string, optional)

idprovider.<idprovidername>.mappings.displayName=  (string, required, defaults to ${userinfo.preferred_username})
idprovider.<idprovidername>.mappings.email=  (string, required, defaults to ${userinfo.email})

idprovider.<idprovidername>.defaultGroups=  (space separated group keys, optional)

idprovider.<idprovidername>.rules.forceEmailVerification=  (true | false, required)

idprovider.<idprovidername>.autoLogin.createUser=  (true|false, optional, defaults to "true")
idprovider.<idprovidername>.autoLogin.createSession=  (true|false, optional, defaults to "false")
# Look for a token in the Sec-WebSocket-Protocol header.
idprovider.<idprovidername>.autoLogin.wsHeader=  (true|false, optional, default to "false")
idprovider.<idprovidername>.autoLogin.allowedAudience=  (space separated strings, optional)
----

{zwsp} +

[[fields_in_config]]
==== Fields in the config

* `autoinit`: Automatic initialization. If the config file contains `autoinit=true`, then during startup this app will automatically create ID providers for all settings declared in the file, if they don't already exist. For example, `idprovider.myfirstidp.someKey=someValue` and `idprovider.anotheridp.anotherKey=anotherValue` will declare two idproviders named `myfirstidp` and `anotheridp`.
* `displayName`: Display name of ID Provider in Users app.
* `description`: Description of ID Provider in Users app.
* `useUserinfo`: Use the Userinfo endpoint to retrieve user claims. When set to `false`, the app will not call the Userinfo endpoint to retrieve user claims.
* `claimUsername`: Claim to use as username when XP User is created. The value is a string, the default value is `sub`.

**Authorization Server**

* `oidcWellKnownEndpoint`: OpenID Provider Configuration URL. If defined, then values for the `issuer`, `authorizationUrl`,`tokenUrl`,`userinfoUrl`,`jwksUri` properties will be fetched from the well-known endpoint. It is highly recommended to set this value to make sure the correct URLs are used.
* `issuer`: Issuer identifier. Value of `issuer` in your OpenID Provider <<#information_required_for_config, configuration>>.
* `authorizationUrl`: Authorization endpoint URL. Value of `authorization_endpoint` in your OpenID Provider <<#information_required_for_config, configuration>>.
* `tokenUrl`: Token endpoint URL. Value of `token_endpoint` in your OpenID Provider <<#information_required_for_config, configuration>>.
* `userinfoUrl`: Userinfo endpoint URL. Value of `userinfo_endpoint` in your OpenID Provider configuration. If provided, the app will use this URL to retrieve the user claims and create/update the User. (When `useUserinfo` is set to `false` this value is not used)
* `jwksUri`: JSON Web Key Set (JWKS) endpoint URL. Value of `jwks_uri` in your OpenID Provider <<#information_required_for_config_auto_login, configuration>>. If provided, the app will use this URL to retrieve the public keys used to verify the signature of the Bearer Token in the Auto Login (there this value is mandatory) and ID Token in the Authorization Code Flow.
* `method`: Client authentication method. The value is a string, either `post`, `basic` or `jwt`. The values correspond to the `client_secret_post`, `client_secret_basic` and `private_key_jwt` methods, respectively.
* `scopes`: Scope/Claims to retrieve in addition to the mandatory `openid` scope. We recommend setting the two standard scopes: _profile_ and _email_. The value is a space-separated list of scopes, e.g. `profile email`.
* `usePkce`: Use The Proof Key of Code Exchange (PKCE). If set to `false`, the app will not use PKCE for the Authorization Code Flow.

**Additional OAuth2 endpoints**

* `additionalEndpoints...` (`idprovider.<idprovidername>.additionalEndpoints...` namespace): Additional OAuth2 endpoints used to retrieve additional user information using the access token. This `additionalEndpoints` namespace _requires an array_ immediately below it, with two required fields below each item in the array. Array starts counting on `0`, so for example, `idprovider.<idprovidername>.additionalEndpoints.0.name` sets the `name` for the first item, while `idprovider.<idprovidername>.additionalEndpoints.1.url` sets `url` for the second one, etc.
  - `name`: Value used to store these claims under a same scope in the user profile.
  - `url`: Endpoint URL.

**End session**

* `endSession...` (`idprovider.<idprovidername>.endSession...` namespace): OIDC Front-Channel Logout configuration parameters. See <<#end_session, End Session>> for more information.
  ** `url`: End session URL. Value of `end_session_endpoint` in your OpenID Provider <<#information_required_for_config, configuration>>.
  ** `idTokenHintKey`: ID Token Hint parameter name. Value of `id_token_hint` in your OpenID Provider <<#information_required_for_config, configuration>>.
  ** `postLogoutRedirectUriKey`: Post logout redirect URI parameter name. Value of `post_logout_redirect_uri` in your OpenID Provider <<#information_required_for_config, configuration>>.
  ** `additionalParameters...` (`idprovider.<idprovidername>.endSession.additionalParameters...` namespace): Additional OIDC Front-Channel Logout. This `additionalParameters` namespace _requires an array_ immediately below it, with two required fields below each item in the array. Array starts counting on `0`, so for example, `idprovider.<idprovidername>.endSession.additionalParameters.0.key` sets the `key` for the first item, while `idprovider.<idprovidername>.endSession.additionalParameters.1.value` sets `value` for the second one, etc.
    *** `key`
    *** `value`


**Client**

The Client parameters are mandatory for the Authorization Code Flow, but not used for Auto Login.


* `clientId`: Client identifier, received or generated during <<#authorization_server, creation of your Client/Application>>
* `clientSecret`: Client secret, received or generated during <<#authorization_server, creation of your Client/Application>>

NOTE: To disable Authorization Code Flow, `clientId` should be omitted.

**User creation**

When logging in for the first time, a user will be created in Enonic XP.

The claims for user creation are retrieved from the following sources:
- ID Token (Authorization Code Flow only)
- Userinfo endpoint (optionally)
- Additional OAuth2 endpoints (if specified)
- Bearer token (Auto Login only)

It is possible to disable User creation for the Auto Login by setting `autoLogin.createUser` to `false`.

The following settings are used to create the user:

* `mappings...` (`idprovider.<idprovidername>.mappings...` namespace): You may configure the rules containing placeholders used to create users inside Enonic: values will be replaced with information provided by the placeholder expression.
  ** `displayName`: Template for the display name in format of `@@{expression}`, e.g. `@@{userinfo.preferred_username}`.
  ** `email`: Template for the email in format of `@@{expression}`, e.g. `@@{userinfo.email}`.
* `defaultGroups` (`idprovider.<idprovidername>.defaultGroups`): Groups to assign to this user on creation. A list of space-separated group keys. The key must be in the format `group:[idprovidername]:[groupname]`, e.g. `group:myoidcprovider:authors`.

**User update**

User update is done only for the Authorization Code Flow on every login. The user's `displayName` and `email` will be updated from the same sources as for user creation.
User profile updated with the claims from the ID Token, Userinfo endpoint and Additional OAuth2 endpoints.

**Auto Login**

* `autoLogin...` (`idprovider.<idprovidername>.autoLogin...` namespace): Auto login configuration. To enable auto login, the `jwksUri` config must be set.
  ** `createUser`: Create a user. If set to `true`, a user will be created automatically if it doesn't exist.
  ** `createSession`: Create a session. If set to `true`, a session will be established upon the user's login. By default, the user will be logged in with `REQUEST` scope.
  ** `wsHeader`: Look for a token in the Sec-WebSocket-Protocol header. If set to `true`, the app will look for a token in the Sec-WebSocket-Protocol header.
  ** `allowedAudience`: Allowed audience. A list of space-separated strings. If set, the app will only accept tokens with an audience that matches one of the values in this list. It is highly recommended to set this value to make sure the correct tokens are used for the auto login.

**Rules**

* `rules...` (`idprovider.<idprovidername>.rules...` namespace): Additional rules enforced on user create.
  ** `forceEmailVerification`: If set to `true` enforce email verification by checking the claim `email_verified` (returned with the scope `email`).

{zwsp} +

[[end_session]]
=== End Session

OpenID Connect Front-Channel Logout is optional and might not be supported by your authentication server.
You can check if the endpoint is available in the Open ID Configuration (`.well-known/openid-configuration`) under the field `end_session_endpoint`
There might also be another custom endpoint available that achieves the same purpose.
The ID Provider Configuration schema tries to be dynamic enough to handle all cases.

{zwsp} +

Example: **Auth0**

* End Session URL: https://`YOUR_AUTH0_DOMAIN`/v2/logout
* Post Logout Redirect URI parameter name: `returnTo`
* Additional Parameters:
** clientId = [Client ID]

{zwsp} +

Example: **Google**

Not available

{zwsp} +

Example: **Azure AD**

* End Session URL: https://login.microsoftonline.com/`TenantID`/oauth2/logout
* Post Logout Redirect URI parameter name: `post_logout_redirect_uri`

{zwsp} +

Example: **ID-porten**

* End Session URL: https://login.idporten.no/logout
* ID Token Hint parameter name: `id_token_hint`
* Post Logout Redirect URI parameter name: `post_logout_redirect_uri`

{zwsp} +

== Upgrade Notes

=== Version 3


- User `displayName` and `email` are now automatically updated when the user logs in with Authorization Code Flow.
- Authorization Code Flow with PKCE is now supported and used by default. Disable it (`usePkce = false`) if your provider does not support it.
- In Authorization Code Flow, the ID Token verification is now done with the public keys from the JWKS URI (`jwksUri`). Since this field is optional the signature verification will not be done if the field is not set. Note, that if `oidcWellKnownEndpoint` is set, the `jwksUri` will be fetched from the well-known endpoint automatically.
- The `clientId` and `clientSecret` fields are now optional in the ID Provider configuration. If you want to disable Authorization Code Flow, `clientId` should be omitted.

=== Version 2

Version `2.0` of this app introduces a breaking change: ID Providers can only be configured via the config file (`com.enonic.app.oidcidprovider.cfg`) instead of editing the ID Provider form in the Users app UI. So, no configuration will be stored in / read from the data layer anymore.

The following upgrade notes assume you currently have an earlier (`1.x`) version of OIDC ID provider app installed:

image:idprovider-migration.png[title="(1) - ID provider name, (2) - pencil button to open form for edit", width=500px]

When editing an ID provider in the Users app, the ID provider name (1) is found (or edited) directly below the displayName field, and in previous versions of this app the configuration form was opened by clicking the pencil (2) icon on the ID provider application.

=== Migrate the configuration
Create `com.enonic.app.oidcidprovider.cfg` in your XP instance's `config` folder. Then in the XP backoffice, open the Users app and edit the ID provider. Note the ID provider name (without the leading slash), and click the edit-form icon to view the configuration entered in the old app. Transfer the values into the `.cfg` file, the way it's specified above (the order may vary).

For mapping config (`idprovider.<idprovidername>.mappings.displayName` and `idprovider.<idprovidername>.mappings.email`), remember the `@@`` syntax for the placeholders. Replace any `${` in the values with `@@{`!

